---
// Componente Head personalizado para agregar scripts y estilos globales
import type { StarlightRouteData } from "@astrojs/starlight/route-data";
import Default from "@astrojs/starlight/components/Head.astro";
---

<Default {...Astro.props} />

<!-- Script para personalizar navegación y dropdown según la ruta -->
<script>
  // Función para filtrar el dropdown del multiSidebar
  function filterMultiSidebarDropdown() {
    const pathname = document.body.getAttribute("data-pathname") || window.location.pathname;
    const isInGuias = pathname.includes("/guias/");
    // Buscar el dropdown del multiSidebar
    const dropdownSelectors = [
      "[data-multi-sidebar-switcher]",
      ".multi-sidebar-switcher",
      'select[aria-label*="sidebar"]',
      'select[aria-label*="Sidebar"]',
      '[role="listbox"]',
      ".sidebar-switcher",
      "nav select",
      "aside select",
      "select",
    ];

    let dropdown = null;
    for (const selector of dropdownSelectors) {
      dropdown = document.querySelector(selector);
      if (dropdown) break;
    }

    if (!dropdown) return;

    // Buscar las opciones dentro del dropdown
    const options = dropdown.querySelectorAll(
      'option, [role="option"], li, button'
    );

    options.forEach((option) => {
      if (!(option instanceof HTMLElement)) return;

      const text = option.textContent?.toLowerCase() || "";

      // SOLO si estamos en /guias/, ocultar la opción de Documentación
      if (isInGuias && text.includes("documentación")) {
        option.style.display = "none";
        option.setAttribute("hidden", "true");
        if (option instanceof HTMLOptionElement) {
          option.disabled = true;
        }
        return;
      }

      // Si NO estamos en /guias/, mostrar todas las opciones
      if (!isInGuias) {
        option.style.display = "";
        option.removeAttribute("hidden");
        if (option instanceof HTMLOptionElement) {
          option.disabled = false;
        }
      }
    });
  }

  function updateSiteTitles() {
    const pathname = document.body.getAttribute("data-pathname") || window.location.pathname;
    const isInGuias = pathname.includes("/guias/");
    const siteTitle = isInGuias ? "Guías de usuario" : "Documentación Integra";
    const titleNodes = document.querySelectorAll(
      ".nova-site-title span[translate='no'], .site-title span[translate='no']"
    );

    titleNodes.forEach((node) => {
      if (node.textContent?.trim() !== siteTitle) {
        node.textContent = siteTitle;
      }
    });

    if (document.title) {
      const parts = document.title.split(" | ");
      if (parts.length > 1) {
        parts[parts.length - 1] = siteTitle;
        document.title = parts.join(" | ");
        return;
      }
    }

    document.title = siteTitle;
  }

  function applyRouteTweaks() {
    const currentPath = window.location.pathname;

    document.body.setAttribute("data-pathname", currentPath);
    filterMultiSidebarDropdown();
    updateSiteTitles();
  }

  // Ejecutar inmediatamente
  applyRouteTweaks();

  // Ejecutar cuando el DOM esté completamente cargado
  document.addEventListener("DOMContentLoaded", applyRouteTweaks);

  // Ejecutar después de navegaciones (View Transitions)
  document.addEventListener("astro:page-load", applyRouteTweaks);

  // Ejecutar con delays para asegurar que los elementos estén disponibles
  setTimeout(applyRouteTweaks, 500);
  setTimeout(applyRouteTweaks, 1000);
</script>

<style is:global>
  /* CSS para forzar ocultación solo en guías */
  body[data-pathname*="/guias/"]
    [data-multi-sidebar-switcher]
    option:first-child,
  body[data-pathname*="/guias/"] select option:first-child {
    display: none !important;
  }
</style>
<!-- Script para agregar data-pathname al body y filtrar dropdown -->
<!-- <script is:inline>
  (function () {
    // Agregar el pathname actual como data attribute al body
    function updatePathname() {
      if (typeof document !== "undefined") {
        document.body.setAttribute("data-pathname", window.location.pathname);
      }
    }

    // Función para filtrar el dropdown del multiSidebar
    function filterMultiSidebarDropdown() {
      const currentPath = window.location.pathname;
      console.log(currentPath);
      const isInDocumentacion = currentPath.includes("/documentacion/");
      const isInGuias = currentPath.includes("/guias/");

      // Buscar el dropdown del multiSidebar (puede ser select, ul, o div con opciones)
      const dropdownSelectors = [
        "[data-multi-sidebar-switcher]",
        ".multi-sidebar-switcher",
        'select[aria-label*="sidebar"]',
        'select[aria-label*="Sidebar"]',
        '[role="listbox"]',
        ".sidebar-switcher",
        "nav select",
        "aside select",
      ];

      let dropdown = null;
      for (const selector of dropdownSelectors) {
        dropdown = document.querySelector(selector);
      }

      // Buscar las opciones dentro del dropdown
      const options = dropdown.querySelectorAll(
        'option, [role="option"], li, button'
      );
      options.forEach((option, index) => {
        const text = option.textContent?.toLowerCase() || "";

        // Si estamos en /guias/, ocultar la opción de Documentación
        if (isInGuias && text.includes("documentación")) {
          option.style.display = "none";
          option.setAttribute("hidden", "true");
          if (option instanceof HTMLOptionElement) {
            option.disabled = true;
          }
        }

        // Si estamos en /documentacion/, ocultar las opciones de guías
        if (
          isInDocumentacion &&
          (text.includes("nomina") ||
            text.includes("nómina") ||
            text.includes("reportes") ||
            text.includes("contabilidad"))
        ) {
          option.style.display = "none";
          option.setAttribute("hidden", "true");
          if (option instanceof HTMLOptionElement) {
            option.disabled = true;
          }
        }

        // En página principal o index, mostrar todo
        if (!isInDocumentacion && !isInGuias) {
          option.style.display = "";
          option.removeAttribute("hidden");
          if (option instanceof HTMLOptionElement) {
            option.disabled = false;
          }
        }
      });
    }

    // Función principal que ejecuta ambas
    function initialize() {
      updatePathname();
      filterMultiSidebarDropdown();
    }

    // Ejecutar cuando el DOM esté listo
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initialize);
    } else {
      initialize();
    }

    // También ejecutar después de navegaciones (View Transitions de Astro)
    document.addEventListener("astro:page-load", initialize);

    // Ejecutar con delays para asegurar que el dropdown se haya renderizado
    setTimeout(initialize, 100);
    setTimeout(initialize, 500);

    // Observer para cuando el dropdown se renderice dinámicamente
    const observer = new MutationObserver(function () {
      filterMultiSidebarDropdown();
    });

    if (document.body) {
      observer.observe(document.body, {
        childList: true,
        subtree: true,
      });
    }
  })();
</script> -->

<style is:global>
  /* CSS adicional para forzar ocultación si JavaScript no funciona inmediatamente */
  body[data-pathname*="/guias/"]
    [data-multi-sidebar-switcher]
    option:first-child,
  body[data-pathname*="/guias/"] [role="option"]:first-child {
    display: none !important;
  }

  /* Ocultar opciones de guías cuando estamos en documentación */
  body[data-pathname*="/documentacion/"]
    [data-multi-sidebar-switcher]
    option:not(:first-child),
  body[data-pathname*="/documentacion/"] [role="option"]:not(:first-child) {
    display: none !important;
  }
</style>
