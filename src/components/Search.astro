---
// Componente Search personalizado para filtrar resultados por sección
import type { StarlightRouteData } from '@astrojs/starlight/route-data';
import Default from '@astrojs/starlight/components/Search.astro';

// Obtener la URL actual
const currentPath = Astro.url.pathname;
const isInDocumentacion = currentPath.includes('/documentacion/');
const isInGuias = currentPath.includes('/guias/');

// Determinar el filtro de búsqueda según la sección
let searchFilter = '';
if (isInGuias) {
  searchFilter = 'guias';
} else if (isInDocumentacion) {
  searchFilter = 'documentacion';
}
---

<!-- Pasar el filtro como data attribute para usarlo en el script de búsqueda -->
<div data-search-filter-wrapper data-search-filter={searchFilter}>
  <Default {...Astro.props} />
</div>

<script>
  // Script para filtrar resultados de búsqueda según la sección
  function setupSearchFilter() {
    const searchContainer = document.querySelector('[data-search-filter-wrapper]');
    if (!searchContainer) return;
    const filterAttr = searchContainer.getAttribute('data-search-filter');
    if (!filterAttr) return;
    const activeFilter = filterAttr.toLowerCase();
    
    // Función para ocultar resultados que no coinciden con el filtro
    function filterResults() {
      const resultBuckets = [
        document.querySelectorAll('.pagefind-ui__result'),
        document.querySelectorAll('.pagefind-ui__suggestion'),
        document.querySelectorAll('[data-pagefind-result]'),
        document.querySelectorAll('[role="option"]')
      ];

      resultBuckets.forEach(bucket => {
        bucket.forEach((result) => {
          const link = result.querySelector('a[href]');
          const reference = link?.getAttribute('href') || link?.textContent || '';
          const normalized = reference.toLowerCase();
          let show = true;

          if (activeFilter === 'guias') {
            show = normalized.includes('/guias/');
          } else if (activeFilter === 'documentacion') {
            show = normalized.includes('/documentacion/');
          }
          if (result instanceof HTMLElement) {
            result.style.display = show ? '' : 'none';
            result.toggleAttribute('hidden', !show);
          }
          if (link instanceof HTMLElement) {
            link.style.display = show ? '' : 'none';
            link.toggleAttribute('hidden', !show);
          }
        });
      });
    }
    
    // Ejecutar inmediatamente
    filterResults();
    
    // Observer para cuando cambien los resultados
    const observer = new MutationObserver(() => {
      setTimeout(filterResults, 100); // Pequeño delay para asegurar que los resultados estén renderizados
    });
    
    // Observar cambios en todo el documento
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
    
    // También ejecutar cuando se haga input en la búsqueda
    document.addEventListener('input', (event) => {
      const target = event.target;
      if (target instanceof HTMLElement && target.matches('[type="search"], .pagefind-ui__search-input, input[placeholder*="Search"]')) {
        setTimeout(filterResults, 200);
      }
    });
  }
  
  // Ejecutar cuando el DOM esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupSearchFilter);
  } else {
    setupSearchFilter();
  }
  
  // También ejecutar cuando se abra el modal de búsqueda (si usa modal)
  document.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      setTimeout(setupSearchFilter, 500);
    }
  });
</script>

<style is:global>
  [data-search-filter-wrapper] {
    display: contents;
  }

  /* Asegurar que los resultados filtrados estén ocultos */
  [data-search-filter-wrapper][data-search-filter="documentacion"] a[href*="/guias/"],
  [data-search-filter-wrapper][data-search-filter="guias"] a[href*="/documentacion/"] {
    display: none !important;
  }
</style>
